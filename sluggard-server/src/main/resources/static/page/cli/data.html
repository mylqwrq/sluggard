<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>数据管理</title>
    <link rel="stylesheet" href="../../resource/layui/css/layui.css">
</head>
<body style="margin-top: 15px">
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-inline">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
                        <legend>项目信息</legend>
                    </fieldset>
                    <form class="layui-form" lay-filter="projectFormFilter" id="projectForm">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">选择项目</label>
                                <div class="layui-input-inline">
                                    <select id="projectSelect" name="name" lay-filter="projectFilter">
                                        <option value="">请选择</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">GroupId</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="groupId" name="groupId" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">ArtifactId</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="artifactId" name="artifactId" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">Version</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="version" name="version" type="text"
                                           autocomplete="off" value="0.0.1-SNAPSHOT">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">Packaging</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="packaging" name="packaging" type="text"
                                           autocomplete="off" value="jar">
                                </div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">项目描述</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="description" name="description" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">基本包路径</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="basePackage" name="basePackage" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">服务端口</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="serverPort" name="serverPort" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">服务路径</label>
                                <div class="layui-input-inline">
                                    <input class="layui-input" id="serverPath" name="serverPath" type="text"
                                           autocomplete="off">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="layui-inline">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
                        <legend>模板信息</legend>
                    </fieldset>
                    <form class="layui-form" lay-filter="projectTemplateFormFilter" id="projectTemplateForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">项目模板</label>
                            <div class="layui-input-block" id="projectTemplateCheck">
                            </div>
                        </div>
                    </form>
                    <form class="layui-form" lay-filter="codeTemplateFormFilter" id="codeTemplateForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">代码模板</label>
                            <div class="layui-input-block" id="codeTemplateCheck">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="layui-inline">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 5px;">
                        <legend>配置信息</legend>
                    </fieldset>
                    <table class="layui-hide" id="dtConfig" lay-filter="dtConfigFilter"></table>
                </div>
                <div class="layui-inline">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        <legend>数&ensp;据&ensp;源</legend>
                    </fieldset>
                    <form class="layui-form" lay-filter="dbFormFilter" id="dbForm">
                        <div class="layui-form-item">
                            <label class="layui-form-label">类型</label>
                            <div class="layui-inline" style="width: 100px;">
                                <select id="dbTypeSelect" name="dbType" lay-filter="dbTypeFilter">
                                </select>
                            </div>
                            地址&#12288;
                            <div class="layui-inline" style="width: 200px;">
                                <input class="layui-input" type="text" name="ip" id="ip" autocomplete="off">
                            </div>
                            端口&#12288;
                            <div class="layui-inline" style="width: 100px;">
                                <input class="layui-input" type="text" name="port" id="port" autocomplete="off"
                                       value="3306">
                            </div>
                            名称&#12288;
                            <div class="layui-inline" style="width: 200px;">
                                <input class="layui-input" type="text" name="name" id="dbName" autocomplete="off">
                            </div>
                            用户&#12288;
                            <div class="layui-inline" style="width: 100px;">
                                <input class="layui-input" type="text" name="user" id="user" autocomplete="off">
                            </div>
                            密码&#12288;
                            <div class="layui-inline" style="width: 100px;">
                                <input class="layui-input" type="password" name="pwd" id="pwd" autocomplete="off">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">忽略前缀</label>
                            <div class="layui-inline" style="width: 360px;">
                                <input class="layui-input" type="text" name="ignorePrefix" id="ignorePrefix"
                                       autocomplete="off">
                            </div>
                            忽略后缀&#12288;
                            <div class="layui-inline" style="width: 360px;">
                                <input class="layui-input" type="text" name="ignoreSuffix" id="ignoreSuffix"
                                       autocomplete="off">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="layui-inline">
                    <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                        <legend>数据信息</legend>
                    </fieldset>
                    <form class="layui-form" lay-filter="tableFormFilter" id="tableForm" style="margin-top: 15px;">
                        <div class="layui-form-item">
                            <label class="layui-form-label">表名称</label>
                            <div class="layui-inline" style="width: 360px;">
                                <input class="layui-input" type="text" name="tableName" id="tableName">
                            </div>
                        </div>
                    </form>
                </div>
                <span class="layui-btn-container">
                    <button class="layui-btn" data-type="search" style="margin-top: 48px;"><i class="layui-icon">&#xe615;</i>查询</button>
                    <button class="layui-btn" data-type="create" style="margin-top: 48px;"><i class="layui-icon">&#xe601;</i>项目生成</button>
                </span>
                <table class="layui-hide" id="dt" lay-filter="dtFilter"></table>
            </div>
        </div>
    </div>
</div>

<script src="../../resource/jquery/jquery-3.4.1.min.js"></script>
<script src="../../resource/layui/layui.js"></script>
<script src="../../common/msg.js"></script>
<script src="../../common/opener.js"></script>
<script src="../../common/tool.js"></script>
<script src="../../common/web.js"></script>
<script type="text/html" id="configToolbarOperation">
    <a class="layui-btn layui-btn-sm" lay-event="add">新建</a>
    <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="remove">删除</a>
</script>
<script type="text/html" id="toolbarOperation">
    <a class="layui-btn layui-btn-sm" lay-event="detail">明细</a>
</script>
<script>
    layui.use(['form', 'table'], function () {
        var form = layui.form;
        var table = layui.table;

        $("#serverPath").blur(function () {
            if ($(this).val().indexOf("/") !== 0) {
                $(this).val("/" + $(this).val());
            }
        });

        //加载项目下拉框选项列表
        $.get(WEB_CONTEXT + '/cli/project/getList?name=', {}, function (result) {
            if (result.success && result.data != null) {
                $.each(result.data, function (index, item) {
                    $("#projectSelect").append("<option value=" + item.name + ">" + item.name + "</option>");
                });
            }
            form.render("select");
        });

        //加载模板复选框选项
        $.get(WEB_CONTEXT + '/basic/template/getList?templateTypeId=1', {}, function (result) {
            if (result.success && result.data != null) {
                $.each(result.data, function (index, item) {
                    $("#projectTemplateCheck").append("<input type=\"checkbox\" name=\"chk-" + item.name + "\" title=\"" + item.name + "\">");
                });
            }
            form.render("checkbox");
        });
        $.get(WEB_CONTEXT + '/basic/template/getList?templateTypeId=0', {}, function (result) {
            if (result.success && result.data != null) {
                $.each(result.data, function (index, item) {
                    $("#codeTemplateCheck").append("<input type=\"checkbox\" name=\"chk-" + item.name + "\" title=\"" + item.name + "\">");
                });
            }
            form.render("checkbox");
        });

        //加载数据库类型下拉框选项
        $.get(WEB_CONTEXT + '/server/enums/getDbTypes', {}, function (result) {
            if (result.success && result.data != null) {
                $.each(result.data, function (index, item) {
                    $("#dbTypeSelect").append("<option value=" + item.id + ">" + item.name + "</option>");
                });
            }
            form.render("select");
        });

        //监听下拉框选择事件
        form.on('select(projectFilter)', function (data) {
            $("#tableName").val("");
            table.render(tableOption);
            if (data.value) {
                var projectResult = getRestResult("/cli/project/getByName?name=" + data.value);
                if (projectResult.success === true) {
                    var project = projectResult.data;
                    form.val('projectFormFilter', {
                        "groupId": project.groupId,
                        "artifactId": project.artifactId,
                        "version": project.version,
                        "packaging": project.packaging,
                        "description": project.description,
                        "basePackage": project.basePackage,
                        "serverPort": project.serverPort,
                        "serverPath": project.serverPath
                    });
                    form.val('projectTemplateFormFilter', strArrToCheckBoxByForm("projectTemplateForm", project.projectTemplateNames));
                    form.val('codeTemplateFormFilter', strArrToCheckBoxByForm("codeTemplateForm", project.codeTemplateNames));
                    form.val('dbFormFilter', {
                        "dbType": project.dbVO.dbType.id,
                        "ip": project.dbVO.ip,
                        "port": project.dbVO.port,
                        "name": project.dbVO.name,
                        "user": project.dbVO.user,
                        "pwd": project.dbVO.pwd,
                        "ignorePrefix": project.dbVO.ignorePrefix,
                        "ignoreSuffix": project.dbVO.ignoreSuffix
                    });
                    configTableOption["data"] = JSON.parse(JSON.stringify(project.templateConfigs));
                    table.render(configTableOption);
                    return;
                } else {
                    msg.error(projectResult.message);
                }
            }
            form.val('projectFormFilter', {
                "groupId": "",
                "artifactId": "",
                "version": "0.0.1-SNAPSHOT",
                "packaging": "jar",
                "description": "",
                "basePackage": "",
                "serverPort": "",
                "serverPath": ""
            });
            form.val('projectTemplateFormFilter', strArrToCheckBoxByForm("projectTemplateForm", []));
            form.val('codeTemplateFormFilter', strArrToCheckBoxByForm("codeTemplateForm", []));
            form.val('dbFormFilter', {
                "dbType": "0",
                "ip": "",
                "port": "3306",
                "name": "",
                "user": "",
                "pwd": "",
                "ignorePrefix": "",
                "ignoreSuffix": ""
            });
            table.render(configTableOption);
        });

        form.on('select(dbTypeFilter)', function (data) {
            if (data.value === "0") {
                $("#port").val("3306");
            } else if (data.value === "1") {
                $("#port").val("1521");
            }
        });

        //表格属性
        var configTableOption = {
            elem: '#dtConfig',
            cellMinWidth: 80,
            even: true,
            cols: [[
                {type: 'numbers', title: '序号', width: 100},
                {field: 'key', title: '配置属性', width: 200, edit: 'text'},
                {field: 'value', title: '配置属性值', width: 250, edit: 'text'},
                {field: 'right', title: '操作', width: 200, align: 'center', toolbar: '#configToolbarOperation'}
            ]],
            data: [{"key": "author", "value": "auto"}]
        };
        var tableOption = {
            elem: '#dt',
            cellMinWidth: 80,
            even: true,
            cols: [[
                {type: 'checkbox', fixed: 'left', width: 50},
                {type: 'numbers', title: '序号', width: 50},
                {field: 'tableName', title: '表名称', sort: true, width: 300},
                {field: 'tableComment', title: '表备注', width: 300},
                {field: 'moduleName', title: '模块名', width: 300},
                {fixed: 'right', title: '操作', width: 300, align: 'center', toolbar: '#toolbarOperation'}
            ]],
            data: [],
            response: {
                statusCode: 200,
                statusName: 'statusCode',
                msgName: 'message',
                countName: '',
                dataName: 'data'
            }
        };

        //表格渲染
        table.render(configTableOption);
        table.render(tableOption);

        //查询表方法
        function reload() {
            if ($("#dbTypeSelect").val() === "" || $("#ip").val() === "" || $("#port").val() === ""
                || $("#dbName").val() === "" || $("#user").val() === "" || $("#pwd").val() === "") {
                msg.warn("请先填写完整的数据源信息！");
                return;
            }
            var dbVO = formToObj($("#dbForm"));
            table.reload('dt', {
                url: WEB_CONTEXT + '/server/db/getTables?tableName=' + $("#tableName").val(),
                method: "post",
                contentType: "application/json",
                where: {
                    dbType: dbVO.dbType,
                    ip: dbVO.ip,
                    port: dbVO.port,
                    name: dbVO.name,
                    user: dbVO.user,
                    pwd: dbVO.pwd,
                    ignorePrefix: dbVO.ignorePrefix,
                    ignoreSuffix: dbVO.ignoreSuffix
                }
            });
        }

        //按钮事件
        var active = {
            search: reload,
            create: projectGenerator
        };
        $('.layui-btn-container .layui-btn').on('click', function () {
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        //项目生成方法
        function projectGenerator() {
            if ($("#groupId").val() === "" || $("#artifactId").val() === "" || $("#version").val() === ""
                || $("#packaging").val() === "" || $("#description").val() === "" || $("#basePackage").val() === ""
                || $("#serverPort").val() === "" || $("#serverPath").val() === "") {
                msg.warn("请先填写完整的项目信息！");
                return;
            }
            var projectTemplateNames = checkToStrArr(formToObj($("#projectTemplateForm")));
            if (projectTemplateNames.length === 0) {
                msg.warn("请选择至少一个项目模板！");
                return;
            }
            var codeTemplateNames = checkToStrArr(formToObj($("#codeTemplateForm")));
            if (codeTemplateNames.length === 0) {
                msg.warn("请选择至少一个代码模板！");
                return;
            }
            var templateConfigs = table.cache["dtConfig"];
            var keyArray = [];
            for (var i = 0, row; i < templateConfigs.length; i++) {
                row = templateConfigs[i];
                if (row.key === "" || row.value === "") {
                    msg.warn("配置属性键和值均不可为空！");
                    return;
                }
                if (keyArray.indexOf(row.key) > -1) {
                    msg.warn("配置属性不可重复：" + row.key + "！");
                    return;
                }
                keyArray.push(row.key);
            }
            if ($("#dbTypeSelect").val() === "" || $("#ip").val() === "" || $("#port").val() === ""
                || $("#dbName").val() === "" || $("#user").val() === "" || $("#pwd").val() === "") {
                msg.warn("请先填写完整的数据源信息！");
                return;
            }
            var tables = table.checkStatus("dt").data;
            if (tables.length === 0) {
                msg.warn("请选择要生成的表！");
                return;
            }
            var dataSource = formToObj($("#dbForm"));
            dataSource.dbType = $("#dbTypeSelect").find("option:selected").text();
            var obj = {};
            obj["projectTemplateNames"] = projectTemplateNames;
            obj["codeTemplateNames"] = codeTemplateNames;
            obj["templateConfigs"] = templateConfigs;
            obj["project"] = formToObj($("#projectForm"));
            obj["dataSource"] = dataSource;
            obj["tables"] = tables;
            exportByPost('/cli/data/projectGenerator', obj);
        }

        //监听操作列工具条
        table.on('tool(dtConfigFilter)', function (obj) {
            var data = obj.data;
            if (obj.event === "add") {
                rowAdd(data);
            } else if (obj.event === 'remove') {
                rowRemove(data);
            }
        });
        table.on('tool(dtFilter)', function (obj) {
            var data = obj.data;
            if (obj.event === 'detail') {
                openDetail(data);
            }
        });

        //新增行方法
        function rowAdd(data) {
            var oldData = table.cache["dtConfig"];
            var newRow = {key: '', value: ''};
            oldData.push(newRow);
            table.reload('dtConfig', {
                data: oldData
            });
        }

        //删除行方法
        function rowRemove(data) {
            var oldData = table.cache["dtConfig"];
            for (var i = 0, row; i < oldData.length; i++) {
                row = oldData[i];
                if (row.key === data.key) {
                    oldData.splice(i, 1);
                    break;
                }
            }
            table.reload('dtConfig', {
                data: oldData
            });
        }

        //明细方法
        function openDetail(data) {
            var obj = {};
            obj["projectTemplateNames"] = checkToStrArr(formToObj($("#projectTemplateForm")));
            obj["codeTemplateNames"] = checkToStrArr(formToObj($("#codeTemplateForm")));
            obj["templateConfigs"] = table.cache["dtConfig"];
            obj["project"] = formToObj($("#projectForm"));
            obj["dataSource"] = formToObj($("#dbForm"));
            obj["tableInfo"] = data;
            opener.open("结构明细", '80%', '80%', 'dataDetail.html', obj, 2, 'exportByPost', '/cli/data/codeGenerator', null, getReqObj);
        }

        function getReqObj(layer, index, layero) {

            var tableForm = layer.getChildFrame('body', index).find('form')[0];
            var tableInfo = formToObj($(tableForm));
            var columnsInfo = $(layero).find('iframe')[0].contentWindow.getTableData();

            var dataSource = formToObj($("#dbForm"));
            dataSource.dbType = $("#dbTypeSelect").find("option:selected").text();

            var reqObj = {};
            reqObj["projectTemplateNames"] = checkToStrArr(formToObj($("#projectTemplateForm")));
            reqObj["codeTemplateNames"] = checkToStrArr(formToObj($("#codeTemplateForm")));
            reqObj["templateConfigs"] = table.cache["dtConfig"];
            reqObj["project"] = formToObj($("#projectForm"));
            reqObj["dataSource"] = dataSource;
            reqObj["table"] = tableInfo;
            reqObj["columns"] = columnsInfo;
            return reqObj;
        }
    });
</script>
</body>
</html>